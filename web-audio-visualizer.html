<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Web Audio Visualizer</title>
    <style>
    body {
         background: #383838 ;
         font-family: tahoma, verdana, sans serif;
      }

      video{
        /*display: none;*/
        visibility: hidden
      }

    div{
        margin-bottom: 5%;
    }

      canvas {
        margin-left:10px;
        margin-top:10px;
        box-shadow: 4px 4px 8px rgba(0,0,0,0.5);
        background: black;
        }
        
        @font-face { 
	    font-family: 'HeaderFont';
            src: url('fonts/MAXRHODES.ttf') format('truetype');
             font-weight: bold;
	
            }
        
     h1 { 
         
        font: 50px 'HeaderFont', Arial, Helvetica, Geneva, sans-serif;
         color: #F0E68C;
        margin-left:10px;
        margin-top:10px;
        }
        
     label {
             margin-top:10px;
            margin-bottom:20px;
        }

/*      #controls{
        position:absolute;
        top: 0px; 
        left:1290px;
        margin-left:10px;
        margin-top:20px;
        margin-bottom:20px;
      }*/
      #controls, canvas{
        float: left;
      }

      #controls{
        margin-left: 2.5%;
        background-color: rgba(90, 90, 90, 1.0);
        padding: 1%;
          margin-top: 10px;
        border-radius: 20px;
      }
        
        .checkboxes span{
            margin-right: 17px;
        }
    </style>
    <script>
    // An IIFE ("Iffy") - see the notes in mycourses
    (function(){
        "use strict";
        
        var NUM_SAMPLES = 256;
        var SOUND_1 = 'media/Celldweller - Frozen (Celldweller vs Blue Stahli).mp3';
        var SOUND_2 = 'media/Evanescence - Lacrymosa.mp3';
        var SOUND_3 = 'media/Celldweller - The Last Firstborn (Remixed by Klayton).mp3';

        var audioElement;
        var analyserNode;
        var canvas,ctx, cameraCanvas, videoElement, cameraCtx;
        var maxRadius = 200;
//        var invert = false, tint = false, tintColor = "red";
        var invert = false, tint = false, tintColor = 'red';
        var desat = 0.0;
        var equalizerRotation = 0, rotationIncrement = 2*Math.PI/400;
        var waveGrad, data, waveformData, currentSong, alpha = 1;
        var innerRadius = 35;
        var currVideo, oldVideo;

        
        function init(){
            // set up canvas stuff
            canvas = document.querySelector('canvas');
            ctx = canvas.getContext("2d");
            videoElement = document.querySelector("video");
            cameraCanvas = document.createElement("canvas");
            cameraCanvas.width = videoElement.clientWidth;
            cameraCanvas.height = videoElement.clientHeight;
            cameraCtx = cameraCanvas.getContext("2d");

            if(navigator.webkitGetUserMedia!=null) { 
                var options = { 
                    video:true, 
                    audio:false 
                    }; 
                 
                //request webcam access 
                navigator.webkitGetUserMedia(options, 
                    function(stream) { 
                        //turn the stream into a magic URL 
                        videoElement.src = window.webkitURL.createObjectURL(stream); 
                    },
                    function(e) { 
                        console.log("error happened"); 
                        alert("You have navigator.webkitGetUserMedia, but an error occurred");
                    
                    } 
                ); 
            };
            
            waveGrad = ctx.createLinearGradient(0, 0, canvas.width, 0);
            waveGrad.addColorStop(0, "rgba(0, 0, 0, 0)");
            waveGrad.addColorStop(1/3, "white");
            waveGrad.addColorStop(2/3, "white");
            waveGrad.addColorStop(1, "rgba(0, 0, 0, 0)");
            
            // get reference to <audio> element on page
            audioElement = document.querySelector('audio');
            
            // call our helper function and get an analyser node
            analyserNode = createWebAudioContextWithAnalyserNode(audioElement);
            
            // get sound track <select> and Full Screen button working
            setupUI();
            
            // load and play default sound into audio element
            playStream(audioElement,SOUND_1);
            
            // start animation loop
            update();
        }
        
        
        function createWebAudioContextWithAnalyserNode(audioElement) {
            var audioCtx, analyserNode, sourceNode;
            // create new AudioContext
            // The || is because WebAudio has not been standardized across browsers yet
            // http://webaudio.github.io/web-audio-api/#the-audiocontext-interface
            audioCtx = new (window.AudioContext || window.webkitAudioContext);
            
            // create an analyser node
            analyserNode = audioCtx.createAnalyser();
            
            /*
            We will request NUM_SAMPLES number of samples or "bins" spaced equally 
            across the sound spectrum.
            
            If NUM_SAMPLES (fftSize) is 256, then the first bin is 0 Hz, the second is 172 Hz, 
            the third is 344Hz. Each bin contains a number between 0-255 representing 
            the amplitude of that frequency.
            */ 
            
            // fft stands for Fast Fourier Transform
            analyserNode.fftSize = NUM_SAMPLES;
            
            // this is where we hook up the <audio> element to the analyserNode
            sourceNode = audioCtx.createMediaElementSource(audioElement); 
            sourceNode.connect(analyserNode);
            
            // here we connect to the destination i.e. speakers
            analyserNode.connect(audioCtx.destination);
            return analyserNode;
        }
        
        function setupUI(){
            currentSong = SOUND_1;
            
            document.querySelector("#trackSelect").onchange = function(e){
                playStream(audioElement,e.target.value);
                currentSong = e.target.value;
            };
            
            document.querySelector("#fsButton").onclick = function(){
                requestFullscreen(canvas);
            };
            
            document.querySelector("#maxRadius").onchange = function(e){
                 document.querySelector("#sliderResults").innerHTML = e.target.value;
                innerRadius = e.target.value;
             };
            
            document.getElementById('invert').onchange = function(e){
                invert = e.target.checked;
            };
            
            document.getElementById('tint').onchange = function(e){
                tint = e.target.checked;
            };

            document.getElementById("tintColor").onchange = function(e){
                tintColor = e.target.value;
                console.log(tintColor);
            };
            
            document.querySelector("#desat").onchange = function(e){
                 document.querySelector("#desatResults").innerHTML = e.target.value+"%";
             };
            
            audioElement.onended=function(){
                
                console.log("called playNext");
                
            if (currentSong == SOUND_1)
                {
                  currentSong = SOUND_2;
                  playStream(audioElement,SOUND_2);
                }
            else if (currentSong == SOUND_2)
                {
                    currentSong = SOUND_3;
                    playStream(audioElement,SOUND_3);
                }
            else if (currentSong == SOUND_3)
                {
                    currentSong = SOUND_1;
                    playStream(audioElement, SOUND_1);
                }
            };
 
            
        }
        
        
        function playStream(audioElement,path){
            audioElement.src = path;
            audioElement.play();
            audioElement.volume = 0.2;
            document.querySelector('#status').innerHTML = "Now playing: " + path;
        }
        
        function update() { 
            // this schedules a call to the update() method in 1/60 seconds
            requestAnimationFrame(update);

            /*
                Nyquist Theorem
                http://whatis.techtarget.com/definition/Nyquist-Theorem
                The array of data we get back is 1/2 the size of the sample rate 
            */
            
            // create a new array of 8-bit integers (0-255)
            data = new Uint8Array(NUM_SAMPLES/2); 
            waveformData = new Uint8Array(NUM_SAMPLES/2); 
            
            
            // populate the array with the frequency data
            // notice these arrays can be passed "by reference" 
            analyserNode.getByteFrequencyData(data);
        
            // OR
            analyserNode.getByteTimeDomainData(waveformData); // waveform data
            
            for(var i=0; i<waveformData.length; i++) 
                waveformData[i] *= 3;
            
            maxRadius = document.querySelector("#maxRadius").value;
            desat = document.querySelector("#desat").value/100;
            
            // DRAW!
            ctx.clearRect(0,0,canvas.width,canvas.height);  
            
            

            // drawing bezier curves
            // color, scaling, where to move it
            
            drawCurve();
            drawRectangle();
            drawEqualizer();
            
            drawWaveform();
        
            motionDetection();
            
            manipulatePixels();
             
        } 
        
        // HELPER
        function makeColor(red, green, blue, alpha){
            var color='rgba('+red+','+green+','+blue+', '+alpha+')';
            return color;
        }
        
         // FULL SCREEN MODE
        function requestFullscreen(element) {
            if (element.requestFullscreen) {
              element.requestFullscreen();
            } else if (element.mozRequestFullscreen) {
              element.mozRequestFullscreen();
            } else if (element.mozRequestFullScreen) { // camel-cased 'S' was changed to 's' in spec
              element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) {
              element.webkitRequestFullscreen();
            }
            // .. and do nothing if the method is not supported
        };
        
        function drawEqualizer(){
            var barWidth = 4;
            //var innerRadius = 35;
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.rotate(equalizerRotation);
            equalizerRotation += rotationIncrement;
            ctx.fillStyle = 'rgba(240, 127, 255, 0.67)'; 

            // loop through the data and draw!
            for(var i=0; i<data.length; i++) {

                ctx.rotate(Math.PI*2/data.length);
                ctx.fillRect(innerRadius, 0, 60 + data[i], barWidth);
            }
            ctx.restore();
        }
        
        function drawWaveform(){
            ctx.save();
            ctx.strokeStyle = waveGrad;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height/2);
            for(var i=0; i<waveformData.length; i++){
                ctx.lineTo(i*canvas.width/waveformData.length, 200+ waveformData[i]);
            }
            ctx.stroke();
            ctx.restore();
        }
        
        function drawCurve()
        {
            drawCurves('rgba(114, 38, 38, 0.30)', 0.8, canvas.width/2, canvas.height/2);
            drawCurves('rgba(114, 38, 38, 0.50)', 1, canvas.width/2, canvas.height/2);
            drawCurves('rgba(114, 38, 38, 0.30)', 1.1, canvas.width/2, canvas.height/2);
            drawCurves('rgba(114, 38, 38, 0.10)', 1.15, canvas.width/2, canvas.height/2);
            
            drawCurves('rgba(66, 35, 96, 0.30)', 1.17, canvas.width/2, canvas.height/2);
            drawCurves('rgba(66, 35, 96, 0.05)', 1.18, canvas.width/2, canvas.height/2);
            drawCurves('rgba(66, 35, 96, 0.02)', 1.20, canvas.width/2, canvas.height/2);
        }
        
        // using bezier curve to create the flower shape
        function drawCurves(color, scale, transX, transY) {
           
            ctx.save();
            ctx.strokeStyle = color;
            ctx.beginPath();
            ctx.translate(transX, transY);
            ctx.scale(scale, scale);
            for (var j = 0; j < 5; j++)
                {
                    // each pedal is rotated 90 degrees
                    ctx.rotate(90*Math.PI/180);
                    // drawing it at the origin, easy to transfer
                    ctx.moveTo(0, 0);
                    
                    // loop through data and change the line width and alpha
                    for(var i=0; i <data.length; i++) {
                    ctx.lineWidth = 3 * data[i];
                    ctx.globalAlpha = 0.1 + data[i];       
                    }

                    ctx.bezierCurveTo(-425, - (canvas.height/2), 425, - (canvas.height /2 ), 0, 0);      
                    ctx.stroke();
                }
            
            ctx.restore();
            ctx.save();
            ctx.globalAlpha =1;
            
            // draw black circle in center, to cover the origin
            ctx.fillStyle = "rgba(0, 0, 0, 0)";
            ctx.beginPath();
            ctx.arc(canvas.width/2,canvas.height/2,innerRadius,0,2*Math.PI);
            ctx.fill();
            ctx.restore();
        }
        
        
        // draws the rectangles and move them to the waveform data
        function drawRectangle() {
             ctx.save();
            
            // create a number of 19 bars
            for (var i = 0; i < 20; i++)
                {
                    
            // left to right, big to small
            drawRectangles('#180528', 5 + (i*32), 16, 200 - (i*20));
            // right to left, big to small
            drawRectangles('#180528', 1230 - (i*32), 16, 200 - (i*20));
                }
            ctx.restore();
          
            // same here, but in lighter color
            for (var i = 0; i < 20; i++)
                {
            drawRectangles('#290745', 5 + (i*32), 16, 150 - (i*20));
            drawRectangles('#290745', 1230 - (i*32), 16, 150 - (i*20));
                }
            
            // same, with the lightest color
             for (var i = 0; i < 20; i++)
                {
            drawRectangles('rgba(240, 127, 255, 0.67)', 5 + (i*32), 16, 30 - (i*20));
            drawRectangles('rgba(240, 127, 255, 0.67)', 1230 - (i*32), 16, 30 - (i*20));
                }
            
            ctx.restore();          
        }
        
        function drawRectangles(color, originX, width, height, alp) {
         ctx.save();
         ctx.fillStyle = color;
         ctx.globalAlpha = 0.2;
        for(var i=0; i < waveformData.length; i++)
        {   
              ctx.fillRect(originX, canvas.height, width, - height - waveformData[i]);
        }
                  
         ctx.restore();
    }

        
        function manipulatePixels(){
            //i) Get all of the rgba pixel data of the canvas by grabbing the ImageData Object
            // https://developer.mozilla.org/en-US/docs/Web/API/ImageData
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            //ii) imageData.data is an 8-bit array - values range from 0-255
            //imageData.data contains 4 values per pixel: 4 x canvas.width x canvas.height = 1024000 values!
            //we're looping through this 60 FPS - wow!
            var data = imageData.data;
            var length = data.length;
            var width = imageData.width;
            
            //iii) Iterate through each pixel
            //We step by 4 so that we can manipulate 1 pixel per iteration
            //data[i] is the red value
            //data[i+1] is the green value
            //data[i+2] is the blue value
            //data[i+3] is the alpha value
            
            //v) Invert every color channel
            if(invert){
                for(var i=0; i<length; i+=4){
                    var red = data[i], green = data[i+1], blue = data[i+2];
                    data[i] = 255 - red; //set red value
                    data[i+1] = 255 - green; //set green value
                    data[i+2] = 255 - blue; //set blue value
                    //data[i+3] is the alpha but we're leaving that alone
                }
            }
            
            if(desat != 0){
                for(var i=0; i<length; i+=4){
                    var avg = (data[i]+data[i+1]+data[i+2])/3;
                    data[i] = desat*avg + (1-desat)*data[i];
                    data[i+1] = desat*avg + (1-desat)*data[i+1];
                    data[i+2] = desat*avg + (1-desat)*data[i+2];


//                        data[i+1] = data[i+2] = avg;
                }
            }

            if(tint){
                switch(tintColor){
                    case "red":
                        for(var i=0; i<length; i+=4){
                         data[i] = data[i]+100;
                        }
                        break;
                    case "green":    
                         for(var i=0; i<length; i+=4){
                         data[i+1] = data[i+1]+100;
                        }
                        break;
                    case "blue":    
                        for(var i=0; i<length; i+=4){
                         data[i+2] = data[i+2]+100;
                        }
                        break;
                    default:
                        break;
                }
            }

            //put the modified data back on the canvas
            ctx.putImageData(imageData, 0, 0);
        }

        function motionDetection(){
            cameraCtx.drawImage(videoElement, 0, 0, cameraCanvas.width, cameraCanvas.height);
            var currVideoData = cameraCtx.getImageData(0, 0, cameraCanvas.width, cameraCanvas.height);

            currVideo = currVideoData.data;
            var length = currVideo.length;
            var width = currVideo.width;

            if(oldVideo != null){
                for( var y = 0 ; y < cameraCanvas.height; y++ ) {
                for( var x = 0 ; x < cameraCanvas.width; x++ ) {
                
                    var indexOld = (y * cameraCanvas.width + x) * 4, oldr = oldVideo[indexOld], oldg = oldVideo[indexOld+1], oldb = oldVideo[indexOld+2], olda = oldVideo[indexOld+3];
                    var indexNew = (y * cameraCanvas.width + x) * 4, r = currVideo[indexNew], g = currVideo[indexNew+1], b = currVideo[indexNew+2], a = currVideo[indexNew+3];
                    if (oldr > r - 15 || oldg > g - 15 || oldb > b - 15) {
                    /*
                        data[indexNew] = 255;
                        data[indexNew+1] = 255; 
                        data[indexNew+2] = 255; 
                        data[indexNew+3] = 255; 
                        detected = true;
                        */
                    } else {
                    
                        currVideo[indexNew] = 255; 
                        currVideo[indexNew+1] = 0; 
                        currVideo[indexNew+2] = 0; 
                        currVideo[indexNew+3] = 255;
                        
                    }
                    
                  } // end for x
                 } // end for y
            }

            

            oldVideo = currVideo;

            ctx.putImageData(currVideoData, 0, 0);
        }
        
        
        window.addEventListener("load",init);
    }());
        
    </script>
</head>
<body>
    
    <video width = "1250" height="700" autoplay></video>
    
    <canvas id="canvas" width="1250" height="700" align="left"></canvas>
    
    <div id="controls">
          <h1>SwedZilla Production</h1>

        
        <audio controls></audio>

        <p>
            <label>Track: 
            <select id="trackSelect" >
                <option value="media/Celldweller - Frozen (Celldweller vs Blue Stahli).mp3">Celldweller - Frozen (Celldweller vs Blue Stahli)</option>
                <option value="media/Evanescence - Lacrymosa.mp3">Evanescence - Lacrymosa.mp3</option>
                <option value="media/Celldweller - The Last Firstborn (Remixed by Klayton).mp3">Celldweller - The Last Firstborn (Remixed by Klayton)</option>
            </select>
          </label>
        </p>

        <button id="fsButton">Go Full Screen</button><br>
        <p id="status">???</p>
        
       <div>
           <label for="maxRadius">Equalizer radius</label>
           <input id="maxRadius" type ="range" min ="25" max="100" step ="5" value ="35"/>
           <span  id="sliderResults">35</span>
       </div>
        
        <div class="checkboxes">
            <span>
              <input type="checkbox" id="invert">
              <label for="invert">Invert</label>
            </span>
            
            <span>
              <input type="checkbox" id="tint">
              <label for="tint">Tint</label>
              <select id="tintColor">
                  <option value="red">Red</option>
                  <option value="blue">Blue</option>
                  <option value="green">Green</option>
              </select>
            </span>
        </div>
        
        <div>
           <label for="desat">Desaturation</label>
           <input id="desat" type ="range" min ="0" max="100" step ="5" value ="0"/>
           <span  id="desatResults">0%</span>
       </div>
    </div>
</body>
</html>
